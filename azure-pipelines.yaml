trigger:
- master
variables:
  python.version: '3.7.6'

pool: myAgentPool

# stages:
# - stage: Build
#   displayName: Build stage
#   jobs:
#   - job: BuildJob
#     pool: 
#       # vmImage: 'ubuntu-18.04'
#       name: myAgentPool
#     steps:    
#     - task: charleszipp.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-installer.TerraformInstaller@0
#       displayName: install terraform
#       inputs:
#         terraformVersion: latest    
#     - task: Bash@3
#       inputs:
#         targetType: 'inline'
#         script: |
#           # Write your commands here
#           # python3.7 -m pip install --upgrade pip
#           # python3.7 -m pip install setup
#           echo "helo"
#           ls -la

    #     python3.7 -m pip install -r requirements.txt
    #   workingDirectory: $(projectRoot)
    # - script: |
    #     export PATH=$HOME/.local/bin:$PATH
    #     make install
    #     make lint
    #   workingDirectory: $(projectRoot)
    #   displayName: 'Run lint tests'
    # - task: ArchiveFiles@2
    #   displayName: 'Archive files'
    #   inputs:
    #     rootFolderOrFile: '$(projectRoot)'
    #     includeRootFolder: false
    #     archiveType: zip
    #     archiveFile: $(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip
    #     replaceExistingArchive: true
stages:

####################################################################
#                       Prepare environment                        #
####################################################################
- stage: Prepare
  displayName: Prepare environment 
  jobs: 
  - deployment: deploy_terraform
    continueOnError: false
    environment: 'TEST'
    strategy:
      runOnce:
        deploy:
          steps:
            - checkout: self

            ######### Step 1: Install Terraform ##########
            - task: charleszipp.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-installer.TerraformInstaller@0
              displayName: install terraform
              inputs:
                terraformVersion: latest   
            # - task: Terraform@2
            #   inputs:
            #     Arguments: 
            #     InstallTerraform: true
            #     UseAzureSub: false
#             # - task: TerraformInstaller@0
#             #   displayName: 'install terraform'
#             #   inputs:
#             #     terraformVersion: 'latest'
            - task: Bash@3
              displayName: init terraform
              inputs:
                targetType: 'inline'
                script: |
                  # Write your commands here
                  cd terraform
                  terraform init

          ######### Step 2: Initialise workspace using terraform init ##########

            - task: Bash@3
              displayName: plan terraform
              inputs:
                targetType: 'inline'
                script: |
                  # Write your commands here
                  cd terraform
                  terraform plan

            ######### Step 3: Deploy Webapp terraform apply ##########
            - task: Bash@3
              displayName: apply terraform
              inputs:
                targetType: 'inline'
                script: |
                  # Write your commands here
                  cd terraform
                  terraform apply -auto-approve



            
####################################################################
#                       Build Slenium zip                          #
####################################################################
- stage: BuildSlenium
  jobs:
  - job: Build
    pool:
      vmImage: 'ubuntu-latest'
      name: 'myAgentPool'
    steps:
    - task: ArchiveFiles@2
      displayName: 'Archive Selenium tests'
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)/automatedtesting/selenium'
        includeRootFolder: false
        archiveType: 'zip'
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId)-selenium-tests.zip'
    - publish: $(Build.ArtifactStagingDirectory)/$(Build.BuildId)-selenium-tests.zip
      displayName: 'Upload Selenium Tests'
      artifact: selenium

####################################################################
#                       Run Test Slenium                           #
####################################################################
- stage: Deployment     
  jobs:
  - deployment: UITests
    displayName: 'UI Tests'
    pool:
      vmImage: 'ubuntu-18.04'
      name: myAgentPool
    environment:  'TEST'
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            displayName: Download selenium
            artifact: selenium
          - task: Bash@3
            displayName: 'Install Selenium'
            inputs:
              targetType: 'inline'
              script: |
                #! /bin/bash
                
                sudo apt-get upgrade -y
                sudo apt-get install python3-pip -y
                sudo apt-get install unzip -y
                sudo apt-get install -y chromium-browser
                sudo apt-get install -y chromium-chromedriver
                sudo apt-get install -y webdriver
                pip3 install selenium
                export PATH=$PATH:/usr/lib/chromium-browser/
                cd $(Pipeline.Workspace)/selenium
                unzip -o $(Pipeline.Workspace)/selenium/$(Build.BuildId)-selenium-tests -d .
          - task: Bash@3
            displayName: 'Run Selenium Tests'
            inputs:
              targetType: 'inline'
              script: |
                # python3 /home/Agent/myagent/_work/1/selenium/login.py > /home/Agent/myagent/_work/1/selenium/seleniumtestrun.log
                python3 /home/Agent/myagent/_work/1/selenium/login.py | tee -a /home/Agent/myagent/_work/1/selenium/seleniumtestrun.log
                cat /home/Agent/myagent/_work/1/selenium/seleniumtestrun.log
                sudo cp /home/Agent/myagent/_work/1/selenium/seleniumtestrun.log /var/log